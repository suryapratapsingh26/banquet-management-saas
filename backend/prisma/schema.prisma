generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

////////////////////
/// CORE MODELS  ///
////////////////////

// SaaS Tenant (The Event Management Company)
model Company {
  id           String           @id @default(uuid())
  name         String
  brandName    String?
  gstNumber    String?
  panNumber    String?
  address      String?
  city         String?
  state        String?
  subscription SubscriptionPlan @default(STARTER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users    User[]
  events   Event[]
  leads    Lead[]
  vendors  Vendor[]
  services Service[]
  halls    BanquetHall[]

  tasks           Task[]
  audits          Audit[]
  escalationRules EscalationRule[]
  escalationLogs  EscalationLog[]
  notifications   Notification[]
  templates       Template[]
}

model User {
  id        String   @id @default(uuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  name      String
  email     String   @unique
  password  String
  role      Role     @default(SALES)
  mobile    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Client {
  id        String     @id @default(uuid())
  // Clients might be shared or specific to a company, usually specific:
  companyId String?
  name      String
  email     String?
  phone     String?
  type      ClientType
  events    Event[]
  leads     Lead[]
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
}

// Module 3: Banquet Hall Management
model BanquetHall {
  id         String        @id @default(uuid())
  companyId  String
  company    Company       @relation(fields: [companyId], references: [id])
  name       String
  city       String
  capacity   Int
  ownership  OwnershipType // OWN or CLIENT_HALL
  commission Float? // If Client Hall

  events Event[] // Events booked here
}

// Module 4: Vendor Management
model Vendor {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])
  name      String
  type      String // Decor, AV, Catering
  rating    Float   @default(0)
  mobile    String?
  email     String?

  assignments EventVendor[]
}

// Module 5: Services & Pricing
model Service {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])
  name      String
  type      String // Decor, AV
  basePrice Float
}

// Module 1: Leads & CRM
model Lead {
  id String @id @default(uuid())

  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  clientId String
  client   Client @relation(fields: [clientId], references: [id])

  clientName String
  eventType  EventType
  eventDate  DateTime?
  stage      LeadStage @default(INQUIRY)
  value      Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// Module 2: Event Dashboard
model Event {
  id        String  @id @default(uuid())
  companyId String
  company   Company @relation(fields: [companyId], references: [id])

  title     String
  eventType EventType
  startDate DateTime
  endDate   DateTime
  guests    Int
  status    EventStatus

  clientId String
  hallId   String?
  client   Client       @relation(fields: [clientId], references: [id])
  hall     BanquetHall? @relation(fields: [hallId], references: [id])

  booking   Booking?
  quotation Quotation?
  payments  Payment[] // âœ… FIX: opposite relation added
  vendors   EventVendor[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model EventVendor {
  id       String @id @default(uuid())
  eventId  String
  vendorId String
  event    Event  @relation(fields: [eventId], references: [id])
  vendor   Vendor @relation(fields: [vendorId], references: [id])
  cost     Float
  status   String // Assigned, Paid
}

////////////////////
/// FINANCIALS   ///
////////////////////

model Booking {
  id        String        @id @default(uuid())
  eventId   String        @unique
  event     Event         @relation(fields: [eventId], references: [id])
  status    BookingStatus
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt
}

model Quotation {
  id      String @id @default(uuid())
  eventId String @unique
  event   Event  @relation(fields: [eventId], references: [id])

  venueCost     Float
  foodCost      Float
  decorCost     Float?
  taxAmount     Float
  discount      Float?
  totalAmount   Float
  advanceAmount Float?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Payment {
  id      String        @id @default(uuid())
  eventId String
  event   Event         @relation(fields: [eventId], references: [id])
  amount  Float
  method  PaymentMethod
  status  PaymentStatus
  paidAt  DateTime      @default(now())
}

////////////////////
/// OPERATIONS   ///
////////////////////

model Task {
  id              String    @id @default(uuid())
  companyId       String
  company         Company   @relation(fields: [companyId], references: [id])
  eventId         String
  title           String
  description     String?
  source          String    @default("MANUAL")
  sourceId        String?
  assignedToRole  String?
  assignedToUser  String?
  priority        String    @default("MEDIUM")
  status          String    @default("OPEN")
  dueTime         DateTime?
  slaMinutes      Int?
  completionProof String[]  @default([])
  completionNote  String?
  isEscalated     Boolean   @default(false)
  escalationLevel Int       @default(0)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

model Audit {
  id             String    @id @default(uuid())
  companyId      String
  company        Company   @relation(fields: [companyId], references: [id])
  eventId        String
  auditType      String
  templateId     String?
  assignedToRole String?
  scheduledTime  DateTime?
  status         String    @default("SCHEDULED")
  items          Json
  score          Int?
  submittedBy    String?
  submittedAt    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

model EscalationRule {
  id             String   @id @default(uuid())
  companyId      String
  company        Company  @relation(fields: [companyId], references: [id])
  trigger        String
  slaMinutes     Int
  escalateToRole String
  notifyChannels String[]
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

model EscalationLog {
  id               String   @id @default(uuid())
  companyId        String
  company          Company  @relation(fields: [companyId], references: [id])
  taskId           String
  eventId          String
  reason           String?
  escalatedToRole  String?
  level            Int      @default(1)
  notifiedChannels String[]
  status           String   @default("ACTIVE")
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
}

model Notification {
  id        String   @id @default(uuid())
  companyId String
  company   Company  @relation(fields: [companyId], references: [id])
  channel   String
  to        String
  message   String
  meta      Json?
  status    String   @default("PENDING")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Template {
  id         String   @id @default(uuid())
  companyId  String
  company    Company  @relation(fields: [companyId], references: [id])
  templateId String
  eventType  String
  taskPhase  String
  tasks      Json
  version    Int      @default(1)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

////////////////////
/// ENUMS       ///
////////////////////

enum Role {
  COMPANY_ADMIN
  SALES
  OPS
  ACCOUNTS
}

enum ClientType {
  INDIVIDUAL
  CORPORATE
  EVENT_PLANNER
}

enum EventType {
  WEDDING
  CONFERENCE
  PARTY
  SEMINAR
  EXHIBITION
  OTHER
}

enum EventStatus {
  TENTATIVE
  CONFIRMED
  CANCELLED
}

enum BookingStatus {
  RESERVED
  CONFIRMED
  CANCELLED
}

enum PaymentMethod {
  CASH
  CARD
  UPI
  BANK_TRANSFER
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
}

enum SubscriptionPlan {
  STARTER
  GROWTH
  ENTERPRISE
}

enum OwnershipType {
  OWN
  CLIENT_HALL
}

enum LeadStage {
  INQUIRY
  PROPOSAL
  NEGOTIATION
  CONFIRMED
  LOST
}
